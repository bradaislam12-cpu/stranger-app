<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title class="tr" data-key="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | SM</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .main-container { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .hero-section { 
            background: linear-gradient(135deg, var(--p), #128c7e); 
            color: white; 
            padding: 40px 20px; 
            border-radius: 25px; 
            text-align: center; 
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(7, 94, 84, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* ØªØ£Ø«ÙŠØ± Ù†Ø¨Ø¶ÙŠ Ø®ÙÙŠÙ Ù„Ù„Ø®Ù„ÙÙŠØ© */
        .hero-section::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotateBg 10s linear infinite;
        }
        @keyframes rotateBg { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .hero-section h1 { font-size: 1.8rem; margin-bottom: 10px; position: relative; z-index: 1; }
        .hero-section p { font-size: 0.9rem; opacity: 0.9; margin-bottom: 20px; position: relative; z-index: 1; }

        .start-btn { 
            background: white; color: var(--p); border: none; padding: 15px 35px; 
            border-radius: 50px; font-weight: bold; font-size: 1.1rem; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; z-index: 1;
        }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        .start-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .section-title { 
            display: flex; align-items: center; gap: 10px; margin: 25px 0 15px; 
            font-size: 1.1rem; color: var(--txt); font-weight: bold;
        }

        .empty-list { 
            text-align: center; padding: 40px 20px; background: var(--card); 
            border-radius: 15px; border: 2px dashed rgba(0,0,0,0.05); opacity: 0.6;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .user-item {
            background: var(--card); padding: 12px 15px; border-radius: 15px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 10px; transition: 0.2s; border: 1px solid rgba(0,0,0,0.03);
        }
        .user-item:hover { transform: scale(1.01); background: var(--bg); }

        .status-badge {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-inline-end: 5px;
        }
        .online { background: #25d366; box-shadow: 0 0 5px #25d366; }
        .offline { background: #999; }

        #requestsList .user-item { border-right: 4px solid var(--p); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="light-mode">

    <div class="header">
        <button class="icon-btn" onclick="location.href='profile.html'" title="Profile">âš™ï¸</button>
        <h2 class="tr" data-key="app_name">Stranger Meeting</h2>
        <div style="display: flex; gap: 8px;">
            <button id="themeBtn" class="icon-btn">ğŸŒ“</button>
            <button id="langBtn" class="friend-btn">EN</button>
        </div>
    </div>

    <div class="main-container">
        <div class="hero-section">
            <h1 class="tr" data-key="welcome">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h1>
            <p class="tr" data-key="startHint">Ø§Ø¨Ø¯Ø£ Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ø¢Ù†</p>
            <button id="startMatchBtn" class="start-btn tr" data-key="start_search">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ ğŸš€</button>
        </div>

        <div id="requestsWrapper" style="display: none;">
            <h3 class="section-title"><span>ğŸ””</span> <span class="tr" data-key="friend_requests">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</span></h3>
            <div id="requestsList"></div>
        </div>

        <h3 class="section-title"><span>ğŸ‘¥</span> <span class="tr" data-key="friends_list">Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</span></h3>
        <div id="friendsList">
            <div class="empty-list tr" data-key="no_friends">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø¨Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ù†Ø§Ø³!</div>
        </div>
    </div>

    <script type="module">
        import { auth, db, toggleLang, toggleTheme, applyTranslations, startDiscovery } from './ui-logic.js';
        import { collection, query, where, onSnapshot, doc, getDoc, setDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const currentLang = localStorage.getItem('preferredLang') || 'ar';
        applyTranslations(currentLang);

        document.getElementById('themeBtn').onclick = toggleTheme;
        document.getElementById('langBtn').onclick = toggleLang;

        // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
        const startBtn = document.getElementById('startMatchBtn');
        startBtn.onclick = async () => {
            startBtn.disabled = true;
            startBtn.innerText = currentLang === 'ar' ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„..." : "Connecting...";
            try {
                await startDiscovery();
            } catch (e) {
                startBtn.disabled = false;
                startBtn.innerText = currentLang === 'ar' ? "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ ğŸš€" : "Start Searching ğŸš€";
            }
        };

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© ---
        function initRequestsListener(uid) {
            const q = query(collection(db, "friend_requests"), where("to", "==", uid));
            onSnapshot(q, async (snapshot) => {
                const wrapper = document.getElementById('requestsWrapper');
                const list = document.getElementById('requestsList');
                
                if (snapshot.empty) {
                    wrapper.style.display = "none";
                    return;
                }

                wrapper.style.display = "block";
                list.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… (Ù„Ø¨Ø³Ø§Ø·Ø© Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§)

                for (const requestDoc of snapshot.docs) {
                    const req = requestDoc.data();
                    const senderSnap = await getDoc(doc(db, "users", req.from));
                    const sender = senderSnap.data() || { fullname: "User" };

                    const item = document.createElement('div');
                    item.className = "user-item";
                    item.innerHTML = `
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="user-avatar">${sender.fullname.charAt(0).toUpperCase()}</div>
                            <span style="font-weight:500;">${sender.fullname}</span>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="friend-btn" onclick="window.manageRequest('${requestDoc.id}', '${req.from}', true)">âœ…</button>
                            <button class="friend-btn" style="background:#e74c3c" onclick="window.manageRequest('${requestDoc.id}', '${req.from}', false)">âŒ</button>
                        </div>
                    `;
                    list.appendChild(item);
                }
            });
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ---
        function initFriendsListener(uid) {
            const q = query(collection(db, "friends"), where("users", "array-contains", uid));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('friendsList');
                if (snapshot.empty) {
                    list.innerHTML = `<div class="empty-list tr" data-key="no_friends">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯.</div>`;
                    return;
                }

                list.innerHTML = "";
                snapshot.forEach(async (friendDoc) => {
                    const friendID = friendDoc.data().users.find(id => id !== uid);
                    
                    // Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø¨Ø§Ø´Ø± Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ¯ÙŠÙ‚ (Ù…ØªØµÙ„/ØºÙŠØ± Ù…ØªØµÙ„)
                    onSnapshot(doc(db, "users", friendID), (snap) => {
                        const friend = snap.data();
                        if (!friend) return;

                        // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØµØ¯ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        let item = document.getElementById(`friend-${friendID}`);
                        if (!item) {
                            item = document.createElement('div');
                            item.id = `friend-${friendID}`;
                            item.className = "user-item";
                            item.onclick = () => location.href = `chat.html?id=${friendID}`;
                            list.appendChild(item);
                        }

                        const statusClass = friend.isOnline ? 'online' : 'offline';
                        const statusText = friend.isOnline ? (currentLang === 'ar' ? 'Ù…ØªØµÙ„' : 'Online') : (currentLang === 'ar' ? 'ØºÙŠØ± Ù…ØªØµÙ„' : 'Offline');

                        item.innerHTML = `
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div class="user-avatar" style="background:${friend.isOnline ? 'var(--p)' : '#999'}">${friend.fullname.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight:bold; color:var(--txt);">${friend.fullname}</div>
                                    <div style="font-size:0.75rem; opacity:0.8; display:flex; align-items:center;">
                                        <span class="status-badge ${statusClass}"></span> ${statusText}
                                    </div>
                                </div>
                            </div>
                            <div class="friend-btn" style="border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center;">ğŸ’¬</div>
                        `;
                    });
                });
            });
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        window.manageRequest = async (docId, fromUid, isAccept) => {
            const myUid = auth.currentUser.uid;
            try {
                if (isAccept) {
                    const combinedID = [fromUid, myUid].sort().join("_");
                    await setDoc(doc(db, "friends", combinedID), {
                        users: [fromUid, myUid],
                        createdAt: Date.now()
                    });
                }
                await deleteDoc(doc(db, "friend_requests", docId));
            } catch (err) { console.error(err); }
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                initRequestsListener(user.uid);
                initFriendsListener(user.uid);
            } else {
                location.href = "login.html";
            }
        });
    </script>
</body>
</html>
