<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="tr" data-key="title">Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù | Stranger Meeting</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .discovery-container { max-width: 600px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .main-card { background: linear-gradient(135deg, var(--p), var(--p-dark)); border-radius: 20px; padding: 30px 20px; text-align: center; color: white; box-shadow: 0 10px 25px rgba(7, 94, 84, 0.2); }
        .main-card h2 { margin-bottom: 8px; font-size: 1.5rem; }
        .main-card p { opacity: 0.9; font-size: 0.85rem; margin-bottom: 20px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ« */
        .tabs { display: flex; background: var(--card); padding: 5px; border-radius: 12px; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: bold; color: var(--txt); transition: 0.3s; position: relative; }
        .tab-btn.active { background: var(--p); color: white; }
        
        .badge { background: #ff3b30; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.65rem; position: absolute; top: 2px; right: 5px; border: 2px solid var(--card); }
        
        /* Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .user-item { background: var(--card); padding: 15px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.03); transition: 0.2s; }
        .user-item:hover { transform: scale(1.02); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 40px; height: 40px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--p); }

        .btn-accept { background: #25d366; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .btn-chat { background: var(--p); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="light-mode">

    <div class="header">
        <h2 class="tr" data-key="appName">Stranger Meeting</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="toggleTheme()" class="icon-btn">ğŸŒ“</button>
            <button id="logoutBtn" class="icon-btn">ğŸšª</button>
        </div>
    </div>

    <div class="discovery-container">
        
        <div class="main-card">
            <h2 class="tr" data-key="startDiscovery">Ø§Ø³ØªÙƒØ´Ø§Ù Ø¬Ø¯ÙŠØ¯ ğŸš€</h2>
            <p class="tr" data-key="discoveryDesc">ØªØ­Ø¯Ø« Ù…Ø¹ ØºØ±Ø¨Ø§Ø¡ ÙŠØ´Ø§Ø±ÙƒÙˆÙ†Ùƒ Ù†ÙØ³ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</p>
            <button class="start-btn" onclick="startDiscovery()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="tab-friends" onclick="showTab('friends')">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
            <button class="tab-btn" id="tab-requests" onclick="showTab('requests')">
                Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span id="reqBadge" class="badge" style="display:none;">0</span>
            </button>
        </div>

        <div id="friends" class="tab-content active">
            <div id="friendsList" style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div id="requests" class="tab-content">
            <div id="requestsList" style="margin-top: 10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>

    </div>

    <div style="height: 75px;"></div>
    <div style="position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100;">
        <button class="icon-btn" style="color: var(--p); font-size: 1.6rem;">ğŸ </button>
        <button class="icon-btn" onclick="location.href='chat.html'" style="font-size: 1.6rem;">ğŸ’¬</button>
        <button class="icon-btn" onclick="location.href='profile.html'" style="font-size: 1.6rem;">âš™ï¸</button>
    </div>

    <script type="module">
        import { auth, db, startDiscovery, toggleTheme } from './ui-logic.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, onSnapshot, doc, getDoc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.startDiscovery = startDiscovery;
        window.toggleTheme = toggleTheme;

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) return location.href = "login.html";

            // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
            onSnapshot(query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "pending")), (snap) => {
                const list = document.getElementById("requestsList");
                const badge = document.getElementById("reqBadge");
                list.innerHTML = snap.empty ? "<p style='text-align:center; opacity:0.5;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø©</p>" : "";
                badge.style.display = snap.empty ? "none" : "inline";
                badge.innerText = snap.size;

                snap.forEach(async (d) => {
                    const req = d.data();
                    const sender = await getDoc(doc(db, "users", req.from));
                    const sData = sender.data();
                    const div = document.createElement("div");
                    div.className = "user-item";
                    div.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar">${sData?.fullname.charAt(0)}</div>
                            <span>${sData?.fullname}</span>
                        </div>
                        <button class="btn-accept" onclick="acceptFriend('${d.id}', '${req.from}', '${user.uid}')">Ù‚Ø¨ÙˆÙ„</button>
                    `;
                    list.appendChild(div);
                });
            });

            // 2. Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
            onSnapshot(query(collection(db, "friends"), where("users", "array-contains", user.uid)), (snap) => {
                const list = document.getElementById("friendsList");
                list.innerHTML = snap.empty ? "<p style='text-align:center; opacity:0.5;'>Ù„Ù… ØªØ¶Ù Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯</p>" : "";
                
                snap.forEach(async (d) => {
                    const fData = d.data();
                    const fId = fData.users.find(id => id !== user.uid);
                    const fDoc = await getDoc(doc(db, "users", fId));
                    const uData = fDoc.data();
                    
                    const div = document.createElement("div");
                    div.className = "user-item";
                    div.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar" style="background:var(--p); color:white;">${uData?.fullname.charAt(0)}</div>
                            <span>${uData?.fullname}</span>
                        </div>
                        <button class="btn-chat" onclick="location.href='chat.html?id=${fId}'">Ø¯Ø±Ø¯Ø´Ø©</button>
                    `;
                    list.appendChild(div);
                });
            });
        });

        // ØªÙ†ÙÙŠØ° Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©
        window.acceptFriend = async (reqId, fromId, toId) => {
            try {
                await deleteDoc(doc(db, "friend_requests", reqId));
                await setDoc(doc(db, "friends", `${fromId}_${toId}`), {
                    users: [fromId, toId],
                    timestamp: serverTimestamp()
                });
                alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØµØ¨Ø­ Ù„Ø¯ÙŠÙƒ ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯.");
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„"); }
        };

        document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href="login.html");
    </script>
</body>
</html>
