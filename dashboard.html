<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title class="tr" data-key="dashboard">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | Stranger Meeting</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .notif-bar {
      position: fixed; top: var(--header-h); right: 10px;
      background: var(--accent); color: white;
      padding: 10px 15px; border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-size: 0.9rem; display: none; z-index: 2000;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body class="light-mode">

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="header">
    <button class="icon-btn" onclick="location.href='profile.html'">ðŸ‘¤</button>
    <h2 class="tr" data-key="app_name">Stranger Meeting</h2>
    <div style="display:flex; gap:8px;">
      <button id="themeBtn" class="icon-btn">ðŸŒ“</button>
      <button id="langBtn" class="friend-btn">EN</button>
      <button id="logoutBtn" class="icon-btn">ðŸšª</button>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
  <div id="notifBar" class="notif-bar"></div>

  <!-- Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø« -->
  <div style="text-align:center; margin:30px;">
    <button id="startBtn" class="start-btn tr" data-key="start_search">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµØ¯ÙŠÙ‚ ðŸš€</button>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ -->
  <div class="profile-card">
    <h3 class="tr" data-key="friends_list">ðŸ‘¥ Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</h3>
    <div id="friendsList"></div>
    <p id="noFriends" class="tr" data-key="no_friends" style="opacity:0.6;"></p>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© -->
  <div class="profile-card">
    <h3 class="tr" data-key="friend_requests">ðŸ”” Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h3>
    <div id="requestsList"></div>
  </div>

  <!-- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† -->
  <div class="profile-card">
    <h3 class="tr" data-key="online">ðŸŸ¢ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h3>
    <div id="onlineUsers"></div>
  </div>

  <script type="module">
    import { auth, db, toggleLang, toggleTheme, applyTranslations, startDiscovery } from './ui-logic.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, query, where, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø«ÙŠÙ…
    const currentLang = localStorage.getItem('preferredLang') || 'ar';
    applyTranslations(currentLang);
    document.getElementById('themeBtn').onclick = toggleTheme;
    document.getElementById('langBtn').onclick = toggleLang;

    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').onclick = () => signOut(auth).then(() => location.href="login.html");

    // Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«
    document.getElementById('startBtn').onclick = async (e) => {
      await startDiscovery(e.target);
    };

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, (user) => {
      if (!user) return location.href = "login.html";
      updateDoc(doc(db, "users", user.uid), { isOnline: true });
      loadFriends(user.uid);
      loadRequests(user.uid);
      loadOnlineUsers(user.uid);
    });

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    function loadFriends(uid) {
      const friendsRef = query(collection(db, "friends"), where("users", "array-contains", uid));
      onSnapshot(friendsRef, (snapshot) => {
        const list = document.getElementById("friendsList");
        list.innerHTML = "";
        if (snapshot.empty) {
          document.getElementById("noFriends").style.display = "block";
        } else {
          document.getElementById("noFriends").style.display = "none";
          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const friendId = data.users.find(u => u !== uid);
            const div = document.createElement("div");
            div.className = "user-item";
            div.innerHTML = `
              <span>${data.names?.[friendId] || "Friend"}</span>
              <button class="friend-btn" onclick="location.href='chat.html?room=${docSnap.id}'">ðŸ’¬</button>
            `;
            list.appendChild(div);
          });
        }
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
    function loadRequests(uid) {
      const reqRef = query(collection(db, "friend_requests"), where("to", "==", uid));
      onSnapshot(reqRef, (snapshot) => {
        const list = document.getElementById("requestsList");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const div = document.createElement("div");
          div.className = "user-item";
          div.innerHTML = `
            <span>${data.from}</span>
            <button class="friend-btn" onclick="acceptRequest('${docSnap.id}', '${data.from}', '${uid}')">âœ…</button>
          `;
          list.appendChild(div);
          showNotif(currentLang === 'ar' ? "ðŸ“© Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯" : "ðŸ“© New friend request");
        });
      });
    }

    // Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø©
    async function acceptRequest(reqId, fromId, toId) {
      try {
        const roomId = [fromId, toId].sort().join("_");
        await updateDoc(doc(db, "friend_requests", reqId), { status: "accepted" });
        await updateDoc(doc(db, "friends", roomId), { users: [fromId, toId] }, { merge: true });
        showNotif(currentLang === 'ar' ? "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯" : "âœ… New friend added");
      } catch (e) {
        console.error("Accept Error:", e);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†
    function loadOnlineUsers(uid) {
      const onlineRef = query(collection(db, "users"), where("isOnline", "==", true));
      onSnapshot(onlineRef, (snapshot) => {
        const list = document.getElementById("onlineUsers");
        list.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.uid !== uid) {
            const div = document.createElement("div");
            div.className = "user-item";
            div.innerHTML = `
              <span>${data.fullname || "User"}</span>
              <button class="friend-btn" onclick="location.href='chat.html?room=${[uid,data.uid].sort().join("_")}'">ðŸ’¬</button>
            `;
            list.appendChild(div);
          }
        });
      });
    }

    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
    function showNotif(text) {
      const bar = document.getElementById("notifBar");
      bar.innerText = text;
      bar.style.display = "block";
      setTimeout(() => bar.style.display = "none", 3000);
    }
  </script>
</body>
</html>
