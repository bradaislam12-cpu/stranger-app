<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="tr" data-key="title">Ø§Ù„Ø§Ø³ØªÙƒØ´Ø§Ù | Stranger Meeting</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .discovery-container { max-width: 600px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .main-card { background: linear-gradient(135deg, var(--p), var(--p-dark)); border-radius: 20px; padding: 40px 20px; text-align: center; color: white; box-shadow: 0 10px 25px rgba(7, 94, 84, 0.2); }
        .main-card h2 { margin-bottom: 10px; font-size: 1.8rem; }
        .main-card p { opacity: 0.9; font-size: 0.9rem; margin-bottom: 25px; }
        
        /* Ø£Ù‚Ø³Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª */
        .section-title { font-weight: bold; margin: 15px 0 10px; display: flex; justify-content: space-between; align-items: center; }
        .badge { background: #ff3b30; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
        .user-item { background: var(--card); padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-accept { background: #25d366; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .btn-chat { background: var(--p); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; border: none; background: #ddd; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: var(--p); color: white; }
    </style>
</head>
<body class="light-mode">

    <div class="header">
        <h2 class="tr" data-key="appName">Stranger Meeting</h2>
        <div style="display: flex; gap: 15px;">
            <button onclick="toggleTheme()" class="icon-btn">ğŸŒ“</button>
            <button id="logoutBtn" class="icon-btn">ğŸšª</button>
        </div>
    </div>

    <div class="discovery-container">
        
        <div class="main-card">
            <h2 class="tr" data-key="startDiscovery">Ø§Ø³ØªÙƒØ´Ø§Ù Ø£Ø´Ø®Ø§Øµ Ø¬Ø¯Ø¯</h2>
            <p class="tr" data-key="discoveryDesc">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­Ø³Ø¨ ØªÙØ¶ÙŠÙ„Ø§ØªÙƒ</p>
            <button class="start-btn" onclick="startDiscovery()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¢Ù† ğŸš€</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('friends')">Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
            <button class="tab-btn" onclick="showTab('requests')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span id="reqBadge" class="badge" style="display:none;">0</span></button>
        </div>

        <div id="friends" class="tab-content active">
            <div class="section-title">Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­Ø¨Ø¨ÙˆÙ†</div>
            <div id="friendsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡...</div>
        </div>

        <div id="requests" class="tab-content">
            <div class="section-title">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</div>
            <div id="requestsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>

    </div>

    <div style="height: 70px;"></div>
    <div style="position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #ddd; z-index: 100;">
        <button class="icon-btn" style="color: var(--p);">ğŸ </button>
        <button class="icon-btn" onclick="location.href='chat.html'">ğŸ’¬</button>
        <button class="icon-btn" onclick="location.href='profile.html'">âš™ï¸</button>
    </div>

    <script type="module">
        import { auth, db, startDiscovery } from './ui-logic.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { collection, query, where, onSnapshot, doc, getDoc, updateDoc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.startDiscovery = startDiscovery;
        window.showTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        onAuthStateChanged(auth, (user) => {
            if (!user) return location.href = "login.html";

            // 1. Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            onSnapshot(query(collection(db, "friend_requests"), where("to", "==", user.uid), where("status", "==", "pending")), (snap) => {
                const list = document.getElementById("requestsList");
                const badge = document.getElementById("reqBadge");
                list.innerHTML = snap.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" : "";
                badge.style.display = snap.empty ? "none" : "inline";
                badge.innerText = snap.size;

                snap.forEach(async (d) => {
                    const req = d.data();
                    const sender = await getDoc(doc(db, "users", req.from));
                    const div = document.createElement("div");
                    div.className = "user-item";
                    div.innerHTML = `
                        <span>${sender.data()?.fullname || 'Ù…Ø³ØªØ®Ø¯Ù…'}</span>
                        <button class="btn-accept" onclick="acceptFriend('${d.id}', '${req.from}', '${user.uid}')">Ù‚Ø¨ÙˆÙ„</button>
                    `;
                    list.appendChild(div);
                });
            });

            // 2. Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ†)
            onSnapshot(query(collection(db, "friends"), where("users", "array-contains", user.uid)), (snap) => {
                const list = document.getElementById("friendsList");
                list.innerHTML = snap.empty ? "Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ØµØ¯Ù‚Ø§Ø¡ Ø¨Ø¹Ø¯" : "";
                
                snap.forEach(async (d) => {
                    const friendData = d.data();
                    const friendId = friendData.users.find(id => id !== user.uid);
                    const friendDoc = await getDoc(doc(db, "users", friendId));
                    
                    const div = document.createElement("div");
                    div.className = "user-item";
                    div.innerHTML = `
                        <span>${friendDoc.data()?.fullname || 'ØµØ¯ÙŠÙ‚'}</span>
                        <button class="btn-chat" onclick="location.href='chat.html?id=${friendId}'">Ø¯Ø±Ø¯Ø´Ø©</button>
                    `;
                    list.appendChild(div);
                });
            });
        });

        // ÙˆØ¸ÙŠÙØ© Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©
        window.acceptFriend = async (reqId, fromId, toId) => {
            await deleteDoc(doc(db, "friend_requests", reqId));
            await setDoc(doc(db, "friends", `${fromId}_${toId}`), {
                users: [fromId, toId],
                timestamp: serverTimestamp()
            });
            alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØµØ¯Ø§Ù‚Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø±Ø§Ø³Ù„ØªÙ‡.");
        };

        document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href="login.html");
    </script>
</body>
</html>
