<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="tr" data-key="profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ | SM</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-card { max-width: 450px; margin: 30px auto; background: var(--card); padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); text-align: center; }
        .avatar { width: 90px; height: 90px; background: var(--p); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .data-box { background: var(--bg); padding: 12px; border-radius: 12px; margin-bottom: 12px; text-align: right; border: 1px solid rgba(0,0,0,0.05); }
        .data-box span { display: block; font-size: 0.75rem; opacity: 0.6; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], select { width: 100%; border: none; background: transparent; font-size: 1rem; color: var(--txt); outline: none; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª */
        .checkbox-group { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            text-align: right; 
            gap: 10px; 
            max-height: 200px; 
            overflow-y: auto; 
            padding: 10px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
        }
        .checkbox-group label { font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        .save-btn { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .save-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .settings-nav { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; }
    </style>
</head>
<body class="light-mode">

    <div class="header">
        <button class="icon-btn" onclick="location.href='dashboard.html'">ğŸ”™</button>
        <h2 class="tr" data-key="profile">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        <button id="logoutBtn" class="icon-btn">ğŸšª</button>
    </div>

    <div class="profile-card">
        <div class="settings-nav">
            <button onclick="toggleTheme()" class="icon-btn" style="color:var(--txt)">ğŸŒ“</button>
            <button onclick="toggleLang()" id="langBtn" class="friend-btn">EN</button>
        </div>

        <div class="avatar" id="uAvatar">?</div>
        <h3 id="uName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
        <p id="uEmail" style="font-size: 0.85rem; opacity: 0.6; margin-bottom: 25px;"></p>

        <div class="data-box">
            <span class="tr" data-key="fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</span>
            <input type="text" id="fullnameInput">
        </div>

        <div class="data-box">
            <span class="tr" data-key="gender">Ø¬Ù†Ø³ÙŠ</span>
            <select id="userGender">
                <option value="male">Ø°ÙƒØ±</option>
                <option value="female">Ø£Ù†Ø«Ù‰</option>
            </select>
        </div>

        <div class="data-box">
            <span class="tr" data-key="seeking">Ø£Ø¨Ø­Ø« Ø¹Ù†</span>
            <select id="seekingGender">
                <option value="male">Ø±Ø¬Ø§Ù„ ÙÙ‚Ø·</option>
                <option value="female">Ù†Ø³Ø§Ø¡ ÙÙ‚Ø·</option>
                <option value="both">Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ø¹Ø´ÙˆØ§Ø¦ÙŠ)</option>
            </select>
        </div>

        <div class="data-box">
            <span class="tr" data-key="country">Ø§Ù„Ø¯ÙˆÙ„Ø©</span>
            <select id="userCountry">
                <option value="Egypt">Ù…ØµØ±</option>
                <option value="Saudi Arabia">Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
                <option value="Algeria">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option>
                <option value="Morocco">Ø§Ù„Ù…ØºØ±Ø¨</option>
                <option value="Iraq">Ø§Ù„Ø¹Ø±Ø§Ù‚</option>
                <option value="Jordan">Ø§Ù„Ø£Ø±Ø¯Ù†</option>
                <option value="UAE">Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª</option>
                <option value="Others">Ø¯ÙˆÙ„ Ø£Ø®Ø±Ù‰</option>
            </select>
        </div>

        <div class="data-box">
            <span class="tr" data-key="interests">Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª</span>
            <div class="checkbox-group" id="interestsContainer">
                <label><input type="checkbox" name="interest" value="Sports"> Ø§Ù„Ø±ÙŠØ§Ø¶Ø©</label>
                <label><input type="checkbox" name="interest" value="Gaming"> Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</label>
                <label><input type="checkbox" name="interest" value="Music"> Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</label>
                <label><input type="checkbox" name="interest" value="Movies"> Ø§Ù„Ø£ÙÙ„Ø§Ù…</label>
                <label><input type="checkbox" name="interest" value="Tech"> Ø§Ù„ØªÙ‚Ù†ÙŠØ©</label>
                <label><input type="checkbox" name="interest" value="Travel"> Ø§Ù„Ø³ÙØ±</label>
                <label><input type="checkbox" name="interest" value="Chat"> Ø¯Ø±Ø¯Ø´Ø©</label>
                <label><input type="checkbox" name="interest" value="Others"> Ø£Ø®Ø±Ù‰</label>
            </div>
        </div>

        <button class="save-btn tr" id="saveProfile" data-key="save">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…</button>
    </div>

    <script type="module">
        import { auth, db, toggleLang, toggleTheme } from './ui-logic.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        window.toggleLang = toggleLang;
        window.toggleTheme = toggleTheme;

        onAuthStateChanged(auth, async (user) => {
            if (!user) return location.href = "login.html";

            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists()) {
                const u = docSnap.data();
                document.getElementById("uName").innerText = u.fullname;
                document.getElementById("fullnameInput").value = u.fullname;
                document.getElementById("uEmail").innerText = u.email;
                document.getElementById("uAvatar").innerText = u.fullname.charAt(0).toUpperCase();
                
                document.getElementById("userGender").value = u.gender || "male";
                document.getElementById("seekingGender").value = u.seeking || "both";
                document.getElementById("userCountry").value = u.country || "Egypt";

                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
                if (u.interests && Array.isArray(u.interests)) {
                    const checkboxes = document.querySelectorAll('input[name="interest"]');
                    checkboxes.forEach(cb => {
                        if (u.interests.includes(cb.value)) cb.checked = true;
                    });
                }
            }
        });

        document.getElementById("saveProfile").onclick = async () => {
            const user = auth.currentUser;
            const btn = document.getElementById("saveProfile");
            
            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙŠ Ù…ØµÙÙˆÙØ© (Array)
            const selectedInterests = [];
            document.querySelectorAll('input[name="interest"]:checked').forEach(cb => {
                selectedInterests.push(cb.value);
            });

            try {
                btn.innerText = "...";
                btn.disabled = true;

                await updateDoc(doc(db, "users", user.uid), {
                    fullname: document.getElementById("fullnameInput").value,
                    gender: document.getElementById("userGender").value,
                    seeking: document.getElementById("seekingGender").value,
                    country: document.getElementById("userCountry").value,
                    interests: selectedInterests // Ø­ÙØ¸Ù‡Ø§ ÙƒÙ…ØµÙÙˆÙØ©
                });

                btn.innerText = "ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ¨";
                setTimeout(() => { btn.innerText = "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…"; btn.disabled = false; }, 2000);
            } catch (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
                btn.disabled = false;
            }
        };

        document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.href="login.html");
    </script>
</body>
</html>
