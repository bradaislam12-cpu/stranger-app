here<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ø¢Ù…Ù†Ø© | SM</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
    .video-grid {
      position: relative; width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }
    #remoteVideo { width: 100%; height: 100%; object-fit: cover; background: #111; }
    #localVideo { 
      position: absolute; bottom: 100px; right: 20px; 
      width: 110px; height: 150px; border-radius: 12px; 
      border: 2px solid rgba(255,255,255,0.3); object-fit: cover; z-index: 10;
      background: #222; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    .video-controls {
      position: absolute; bottom: 30px; left: 50%; 
      transform: translateX(-50%); display: flex; gap: 15px; z-index: 20;
    }
    .call-btn {
      width: 55px; height: 55px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem; transition: 0.3s; border: none; cursor: pointer;
    }
    .end-call { background: #ff4d4f; color: white; }
    .toggle-btn { background: rgba(255,255,255,0.15); color: white; backdrop-filter: blur(10px); }
    .toggle-btn.off { background: #ff4d4f; }
    
    .call-info {
      position: absolute; top: 20px; left: 20px; z-index: 20;
      color: white; background: rgba(0,0,0,0.4); padding: 10px 15px;
      border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(5px);
    }
  </style>
</head>
<body class="dark-mode">

  <div class="call-info">
    <span id="statusIndicator">ğŸ”’ Ø¬Ø§Ø±ÙŠ ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„...</span>
  </div>

  <div class="video-grid">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div class="video-controls">
      <button id="toggleMic" class="call-btn toggle-btn">ğŸ¤</button>
      <button id="endCallBtn" class="call-btn end-call">ğŸ“</button>
      <button id="toggleCam" class="call-btn toggle-btn">ğŸ“·</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './ui-logic.js';
    import { doc, setDoc, onSnapshot, updateDoc, getDoc, deleteDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const roomID = urlParams.get('room');
    const role = urlParams.get('role'); // caller or receiver

    if (!roomID) window.location.replace("dashboard.html");

    const servers = {
      iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }],
      iceCandidatePoolSize: 10,
    };

    let pc = new RTCPeerConnection(servers);
    let localStream = null;
    let remoteStream = new MediaStream();

    async function initCall() {
      // 1. Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      } catch (e) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
        return;
      }

      // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ø¨Ø¹ÙŠØ¯
      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        document.getElementById('remoteVideo').srcObject = remoteStream;
        document.getElementById('statusIndicator').innerText = "Ù…ØªØµÙ„ Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† âœ…";
      };

      const callDoc = doc(db, "videoCalls", roomID);
      const offerCandidates = collection(callDoc, "offerCandidates");
      const answerCandidates = collection(callDoc, "answerCandidates");

      pc.onicecandidate = event => {
        if (event.candidate) {
          addDoc(role === 'caller' ? offerCandidates : answerCandidates, event.candidate.toJSON());
        }
      };

      // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ù„Ø¨ (Signaling)
      if (role === 'caller') {
        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);

        await setDoc(callDoc, { offer: { type: offerDescription.type, sdp: offerDescription.sdp } });

        onSnapshot(callDoc, snapshot => {
          const data = snapshot.data();
          if (!pc.currentRemoteDescription && data?.answer) {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          }
        });

        onSnapshot(answerCandidates, snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          });
        });

      } else {
        const callData = (await getDoc(callDoc)).data();
        await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);
        await updateDoc(callDoc, { answer: { type: answerDescription.type, sdp: answerDescription.sdp } });

        onSnapshot(offerCandidates, snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          });
        });
      }

      // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø¥Ø°Ø§ Ø­Ø°Ù Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ø§Ù„ØºØ±ÙØ©
      onSnapshot(callDoc, snap => {
        if (!snap.exists()) endCall();
      });
    }

    async function endCall() {
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      if (pc) pc.close();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase Ù‚Ø¨Ù„ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©
      if (auth.currentUser) {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { isBusy: false });
        await deleteDoc(doc(db, "videoCalls", roomID)).catch(()=>{});
      }
      
      window.location.replace("dashboard.html");
    }

    document.getElementById('endCallBtn').onclick = endCall;

    document.getElementById('toggleMic').onclick = function() {
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      this.innerText = audioTrack.enabled ? "ğŸ¤" : "ğŸ”‡";
      this.classList.toggle('off', !audioTrack.enabled);
    };

    document.getElementById('toggleCam').onclick = function() {
      const videoTrack = localStream.getVideoTracks()[0];
      videoTrack.enabled = !videoTrack.enabled;
      this.innerText = videoTrack.enabled ? "ğŸ“·" : "ğŸš«";
      this.classList.toggle('off', !videoTrack.enabled);
    };

    auth.onAuthStateChanged(user => {
      if (user) initCall();
      else window.location.replace("login.html");
    });
  </script>
</body>
</html>
