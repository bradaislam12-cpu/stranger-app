here<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title class="tr" data-key="secure_chat">Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ Ø¢Ù…Ù†Ø© | SM</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .video-grid {
      position: relative; width: 100%; height: calc(100vh - var(--header-h));
      background: #000; display: flex; align-items: center; justify-content: center;
    }
    #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
    #localVideo { 
      position: absolute; bottom: 20px; right: 20px; 
      width: 120px; height: 160px; border-radius: 12px; 
      border: 2px solid white; object-fit: cover; z-index: 10;
    }
    .video-controls {
      position: absolute; bottom: 30px; left: 50%; 
      transform: translateX(-50%); display: flex; gap: 20px; z-index: 20;
    }
    .call-btn {
      width: 60px; height: 60px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center;
      font-size: 1.5rem; transition: 0.3s;
    }
    .end-call { background: var(--danger); color: white; }
    .toggle-btn { background: rgba(255,255,255,0.2); color: white; backdrop-filter: blur(5px); }
  </style>
</head>
<body class="dark-mode">

  <div class="header">
    <h2 class="tr" data-key="secure_chat">Ù…ÙƒØ§Ù„Ù…Ø© Ù…Ø´ÙØ±Ø© ğŸ”’</h2>
    <div id="statusIndicator" style="font-size: 0.8rem; color: #accent;">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„...</div>
  </div>

  <div class="video-grid">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>

    <div class="video-controls">
      <button id="toggleMic" class="call-btn toggle-btn">ğŸ¤</button>
      <button id="endCallBtn" class="call-btn end-call">ğŸ“</button>
      <button id="toggleCam" class="call-btn toggle-btn">ğŸ“·</button>
    </div>
  </div>

  <script type="module">
    import { auth, db, doc, setDoc, onSnapshot, updateDoc, getDoc } from './ui-logic.js';

    const urlParams = new URLSearchParams(window.location.search);
    const roomID = urlParams.get('room');
    
    if (!roomID) window.location.replace("dashboard.html");

    const servers = {
      iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }]
    };

    let pc = new RTCPeerConnection(servers);
    let localStream = null;
    let remoteStream = new MediaStream();

    async function initCall() {
      // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„Ù„Ù€ Peer Connection
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©
      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        document.getElementById('remoteVideo').srcObject = remoteStream;
        document.getElementById('statusIndicator').innerText = "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù† âœ…";
      };

      // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª (Signaling) Ø¹Ø¨Ø± Firestore
      const roomRef = doc(db, "calls", roomID);

      // Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„Ù…Ù†Ø´Ø¦)
      const roomSnap = await getDoc(roomRef);
      if (!roomSnap.exists()) {
        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);
        
        await setDoc(roomRef, { 
          offer: { type: offerDescription.type, sdp: offerDescription.sdp } 
        });

        onSnapshot(roomRef, snapshot => {
          const data = snapshot.data();
          if (!pc.currentRemoteDescription && data?.answer) {
            pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          }
        });
      } 
      // Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
      else {
        const data = roomSnap.data();
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        
        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);
        await updateDoc(roomRef, { 
          answer: { type: answerDescription.type, sdp: answerDescription.sdp } 
        });
      }

      // ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ù€ ICE Candidates (Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
      pc.onicecandidate = event => {
        if (event.candidate) {
          // Ø­ÙØ¸ Ø§Ù„Ù€ Candidates ÙÙŠ Firestore Ù„ÙŠØ±Ø§Ù‡Ø§ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
          // (ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… sub-collection Ù‡Ù†Ø§ Ù„Ù„Ø³Ø±Ø¹Ø©)
        }
      };
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    document.getElementById('endCallBtn').onclick = () => {
      localStream.getTracks().forEach(track => track.stop());
      window.location.replace("dashboard.html");
    };

    document.getElementById('toggleMic').onclick = () => {
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
      document.getElementById('toggleMic').innerText = audioTrack.enabled ? "ğŸ¤" : "ğŸ”‡";
    };

    document.getElementById('toggleCam').onclick = () => {
      const videoTrack = localStream.getVideoTracks()[0];
      videoTrack.enabled = !videoTrack.enabled;
      document.getElementById('toggleCam').innerText = videoTrack.enabled ? "ğŸ“·" : "ğŸš«";
    };

    auth.onAuthStateChanged(user => {
      if (user) initCall();
      else window.location.replace("login.html");
    });
  </script>
</body>
</html>
