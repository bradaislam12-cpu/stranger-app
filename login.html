<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title class="tr" data-key="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | Stranger Meeting</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="light-mode">

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="header">
    <h2 class="tr" data-key="app_name">Stranger Meeting</h2>
    <div style="display:flex; gap:8px;">
      <button id="themeBtn" class="icon-btn">ğŸŒ“</button>
      <button id="langBtn" class="friend-btn">EN</button>
    </div>
  </div>

  <!-- ØµÙ†Ø¯ÙˆÙ‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="auth-box">
    <h2 class="tr" data-key="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <p class="tr" data-key="welcome_back">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!</p>

    <form id="loginForm">
      <label class="tr" data-key="email_label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="loginEmail" placeholder="example@mail.com" required>

      <label class="tr" data-key="pass_label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="6">

      <!-- Ø®ÙŠØ§Ø± ØªØ°ÙƒØ±Ù†ÙŠ -->
      <div style="margin:10px 0;">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">ØªØ°ÙƒØ±Ù†ÙŠ</label>
      </div>

      <!-- ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø³ÙŠØ·Ø© -->
      <div style="margin:10px 0;">
        <span id="captchaQuestion"></span>
        <input type="text" id="captchaAnswer" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" required>
      </div>

      <button type="submit" id="loginBtn" class="start-btn tr" data-key="login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>

    <button id="googleBtn" class="friend-btn tr" data-key="google_login" style="margin-top:15px;">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¬ÙˆØ¬Ù„ G</button>

    <div id="errorBox" style="color:var(--danger); margin-top:10px; display:none;"></div>

    <div style="margin-top: 25px; font-size: 0.9rem;">
      <span class="tr" data-key="no_account">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</span>
      <a href="register.html" style="color: var(--p); font-weight: bold; text-decoration: none; margin-inline-start: 5px;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
    </div>
  </div>

  <script type="module">
    import { auth, loginWithGoogle, toggleLang, toggleTheme, applyTranslations } from './ui-logic.js';
    import { signInWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const currentLang = localStorage.getItem('preferredLang') || 'ar';
    applyTranslations(currentLang);

    document.getElementById('themeBtn').onclick = toggleTheme;
    document.getElementById('langBtn').onclick = toggleLang;

    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const errorBox = document.getElementById('errorBox');

    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø³ÙŠØ·Ø© (Ø³Ø¤Ø§Ù„ Ø±ÙŠØ§Ø¶ÙŠ)
    let captchaResult;
    function generateCaptcha() {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      captchaResult = a + b;
      document.getElementById('captchaQuestion').innerText = currentLang === 'ar' 
        ? `Ù…Ø§ Ù†ØªÙŠØ¬Ø© ${a} + ${b} ØŸ` 
        : `What is ${a} + ${b}?`;
    }
    generateCaptcha();

    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const pass = document.getElementById('loginPass').value;
      const remember = document.getElementById('rememberMe').checked;
      const captchaAnswer = document.getElementById('captchaAnswer').value.trim();

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§
      if (parseInt(captchaAnswer) !== captchaResult) {
        errorBox.style.display = "block";
        errorBox.innerText = currentLang === 'ar' ? "Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : "Incorrect CAPTCHA answer";
        generateCaptcha(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¨ØªØ´Ø§ Ø¬Ø¯ÙŠØ¯Ø©
        return;
      }

      try {
        errorBox.style.display = "none";
        loginBtn.disabled = true;
        loginBtn.innerText = currentLang === 'ar' ? "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„..." : "Logging in...";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© (Remember Me)
        await setPersistence(auth, remember ? browserLocalPersistence : browserSessionPersistence);

        await signInWithEmailAndPassword(auth, email, pass);
        window.location.replace("dashboard.html");
      } catch (error) {
        loginBtn.disabled = false;
        loginBtn.innerText = currentLang === 'ar' ? "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" : "Login";
        errorBox.style.display = "block";

        switch (error.code) {
          case 'auth/user-not-found':
            errorBox.innerText = currentLang === 'ar' ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯" : "No account with this email";
            break;
          case 'auth/wrong-password':
            errorBox.innerText = currentLang === 'ar' ? "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : "Incorrect password";
            break;
          case 'auth/invalid-email':
            errorBox.innerText = currentLang === 'ar' ? "Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­" : "Invalid email address";
            break;
          default:
            errorBox.innerText = currentLang === 'ar' ? "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©" : "Login failed, try again";
        }
      }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
    document.getElementById('googleBtn').onclick = loginWithGoogle;
  </script>
</body>
</html>
