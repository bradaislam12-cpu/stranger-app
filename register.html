<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title class="tr" data-key="register_title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ | Stranger Meeting</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .register-form {
      max-width: 800px; margin: 20px auto; padding: 20px;
      background: var(--card); border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    .register-form label { display:block; margin:10px 0 5px; font-weight:bold; }
    .register-form input, .register-form select {
      width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;
      margin-bottom:15px;
    }
    .checkbox-group {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:10px;
    }
    .danger-btn {
      background: var(--danger); color:white; padding:12px; border:none;
      border-radius:8px; cursor:pointer; width:100%; margin-top:15px;
    }
    .avatar {
      text-align:center; margin-bottom:20px;
    }
    .avatar img {
      width:120px; height:120px; border-radius:50%; object-fit:cover;
      border:3px solid var(--p);
    }
  </style>
</head>
<body class="light-mode">

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="header">
    <button class="icon-btn" onclick="location.href='index.html'">ğŸ”™</button>
    <h2 class="tr" data-key="register_title">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <div style="display:flex;gap:8px;">
      <button id="themeBtn" class="icon-btn">ğŸŒ“</button>
      <button id="langBtn" class="friend-btn">EN</button>
    </div>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <div class="register-form">
    <form id="registerForm">
      <!-- ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© -->
      <div class="avatar">
        <img id="avatarPreview" src="default-avatar.png" alt="Avatar">
        <input type="file" id="avatarUpload" accept="image/*">
      </div>

      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="fullname" required>

      <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="email" required>

      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="password" required minlength="6">

      <label>Ø§Ù„Ø¬Ù†Ø³</label>
      <select id="gender">
        <option value="male">Ø°ÙƒØ±</option>
        <option value="female">Ø£Ù†Ø«Ù‰</option>
      </select>

      <label>Ø£Ù‡ØªÙ… Ø¨Ù…Ù‚Ø§Ø¨Ù„Ø©</label>
      <select id="seeking">
        <option value="male">Ø±Ø¬Ø§Ù„</option>
        <option value="female">Ù†Ø³Ø§Ø¡</option>
        <option value="both">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
      </select>

      <label>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
      <select id="country"></select> <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->

      <label>Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</label>
      <div class="checkbox-group" id="interestsList"></div>

      <!-- ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø³ÙŠØ·Ø© -->
      <div style="margin:10px 0;">
        <span id="captchaQuestion"></span>
        <input type="text" id="captchaAnswer" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" required>
      </div>

      <button type="submit" class="start-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…</button>
    </form>

    <div id="statusMsg" style="margin-top:10px;color:var(--p);font-weight:bold;"></div>
  </div>

  <script type="module">
    import { auth, db, toggleLang, toggleTheme, applyTranslations } from './ui-logic.js';
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const currentLang = localStorage.getItem('preferredLang') || 'ar';
    applyTranslations(currentLang);
    document.getElementById('themeBtn').onclick = toggleTheme;
    document.getElementById('langBtn').onclick = toggleLang;

    const registerForm = document.getElementById("registerForm");
    const statusMsg = document.getElementById("statusMsg");

    // âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆÙ„ (Ù…Ø®ØªØµØ±Ø© Ù‡Ù†Ø§ØŒ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù…Ù„Ù Ø®Ø§Ø±Ø¬ÙŠ JSON)
    const countries = ["Algeria","Morocco","Tunisia","Egypt","Saudi Arabia","France","Germany","Italy","Spain","UK","USA","Canada","Brazil","Argentina","Mexico","Japan","China","India","Russia","South Africa","Australia","New Zealand"];
    const countrySelect = document.getElementById("country");
    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      countrySelect.appendChild(opt);
    });

    // âœ… Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª
    const interests = ["Sports","Gaming","Tech","AI","Music","Art","Travel","Reading","Cooking","Coding","Movies","Photography","Fitness","Nature","Languages","Fashion","Cars","Science","History","Politics","Animals","Food","Business","Education","Volunteering","Meditation","Gardening","Pets","Comics","Board Games","Dance","Writing","Astronomy","DIY"];
    const interestsList = document.getElementById("interestsList");
    interests.forEach(i => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${i}"> ${i}`;
      interestsList.appendChild(label);
    });

    // âœ… Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
    const avatarUpload = document.getElementById("avatarUpload");
    const avatarPreview = document.getElementById("avatarPreview");
    avatarUpload.onchange = () => {
      const file = avatarUpload.files[0];
      if (file) {
        avatarPreview.src = URL.createObjectURL(file);
      }
    };

    // âœ… ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø³ÙŠØ·Ø©
    let captchaResult;
    function generateCaptcha() {
      const a = Math.floor(Math.random() * 10) + 1;
      const b = Math.floor(Math.random() * 10) + 1;
      captchaResult = a + b;
      document.getElementById('captchaQuestion').innerText = currentLang === 'ar'
        ? `Ù…Ø§ Ù†ØªÙŠØ¬Ø© ${a} + ${b} ØŸ`
        : `What is ${a} + ${b}?`;
    }
    generateCaptcha();

    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      const fullname = document.getElementById("fullname").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const gender = document.getElementById("gender").value;
      const seeking = document.getElementById("seeking").value;
      const country = document.getElementById("country").value;
      const interests = Array.from(document.querySelectorAll("#interestsList input:checked")).map(cb => cb.value);
      const captchaAnswer = document.getElementById("captchaAnswer").value.trim();

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§
      if (parseInt(captchaAnswer) !== captchaResult) {
        statusMsg.innerText = currentLang === 'ar' ? "Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" : "Incorrect CAPTCHA answer";
        generateCaptcha();
        return;
      }

      try {
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), {
          uid: userCred.user.uid,
          fullname, email, gender, seeking, country, interests,
          isOnline: true, isBusy: false,
          avatarUrl: avatarPreview.src
        });
        statusMsg.innerText = currentLang === 'ar' ? "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰" : "Account created successfully! ğŸ‰";
        setTimeout(() => window.location.replace("dashboard.html"), 1500);
      } catch (error) {
        statusMsg.innerText = currentLang === 'ar' ? "ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø­Ø§ÙˆÙ„ Ø«Ø§Ù†ÙŠØ©" : "Registration failed, try again";
      }
    };
  </script>
</body>
</html>
