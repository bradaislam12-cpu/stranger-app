<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title class="tr" data-key="secure_chat">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© | Stranger Meeting</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .msg-meta {
      font-size: 0.7rem; opacity: 0.6; margin-top: 3px;
    }
    .typing-indicator {
      font-size: 0.85rem; opacity: 0.7; margin: 5px 10px;
      font-style: italic; color: var(--accent);
    }
    .input-bar button.attach-btn {
      background: none; border: none; font-size: 1.4rem;
      cursor: pointer; color: var(--p-dark);
    }
  </style>
</head>
<body class="light-mode">

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="header">
    <button class="icon-btn" onclick="location.href='dashboard.html'">ðŸ”™</button>
    <h2 id="chatTitle" class="tr" data-key="secure_chat">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù…Ù†Ø© ðŸ”’</h2>
    <div style="display:flex; gap:8px;">
      <button id="themeBtn" class="icon-btn">ðŸŒ“</button>
      <button id="langBtn" class="friend-btn">EN</button>
    </div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <div class="msg-container" id="messages"></div>
  <div id="typingIndicator" class="typing-indicator" style="display:none;">...</div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
  <div class="input-bar">
    <button class="attach-btn" id="attachBtn">ðŸ“Ž</button>
    <input type="file" id="fileInput" style="display:none" accept="image/*,application/pdf">
    <input type="text" id="msgInput" class="tr" data-key="type_message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button id="sendBtn" class="start-btn tr" data-key="send">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <script type="module">
    import { auth, db, toggleLang, toggleTheme, applyTranslations } from './ui-logic.js';
    import { doc, setDoc, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, updateDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const storage = getStorage();

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø«ÙŠÙ…
    const currentLang = localStorage.getItem('preferredLang') || 'ar';
    applyTranslations(currentLang);
    document.getElementById('themeBtn').onclick = toggleTheme;
    document.getElementById('langBtn').onclick = toggleLang;

    // Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const urlParams = new URLSearchParams(window.location.search);
    const roomID = urlParams.get('room');
    if (!roomID) location.href = "dashboard.html";

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const attachBtn = document.getElementById("attachBtn");
    const fileInput = document.getElementById("fileInput");

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const msgsRef = collection(db, "rooms", roomID, "messages");
    const q = query(msgsRef, orderBy("timestamp"));
    onSnapshot(q, (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const msg = docSnap.data();
        const div = document.createElement("div");
        div.className = "msg " + (msg.from === auth.currentUser.uid ? "me" : "them");

        if (msg.type === "file") {
          div.innerHTML = `<a href="${msg.url}" target="_blank">ðŸ“Ž ${msg.fileName}</a>`;
        } else if (msg.type === "image") {
          div.innerHTML = `<img src="${msg.url}" style="max-width:200px; border-radius:10px;">`;
        } else {
          div.innerText = msg.text;
        }

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.innerText = msg.senderName + " â€¢ " + new Date(msg.timestamp?.seconds*1000).toLocaleTimeString();
        div.appendChild(meta);

        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
    sendBtn.onclick = async () => {
      const text = msgInput.value.trim();
      if (!text) return;
      msgInput.value = "";
      try {
        await addDoc(msgsRef, {
          from: auth.currentUser.uid,
          senderName: auth.currentUser.displayName || "User",
          text: text,
          type: "text",
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.error("Send Error:", e);
      }
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    msgInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
      else {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
        updateDoc(doc(db, "rooms", roomID, "typing", auth.currentUser.uid), { isTyping: true });
      }
    });

    msgInput.addEventListener("blur", () => {
      updateDoc(doc(db, "rooms", roomID, "typing", auth.currentUser.uid), { isTyping: false });
    });

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
    onSnapshot(collection(db, "rooms", roomID, "typing"), (snapshot) => {
      let someoneTyping = false;
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.uid !== auth.currentUser.uid && data.isTyping) someoneTyping = true;
      });
      typingIndicator.style.display = someoneTyping ? "block" : "none";
      typingIndicator.innerText = currentLang === 'ar' ? "ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†..." : "Typing...";
    });

    // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„ÙØ§Øª ÙˆØµÙˆØ±
    attachBtn.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const fileRef = ref(storage, `rooms/${roomID}/${Date.now()}_${file.name}`);
      try {
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        await addDoc(msgsRef, {
          from: auth.currentUser.uid,
          senderName: auth.currentUser.displayName || "User",
          type: file.type.startsWith("image/") ? "image" : "file",
          fileName: file.name,
          url: url,
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.error("File Upload Error:", e);
      }
    };
  </script>
</body>
</html>
